# Gateway API HTTPRoutes for IIDI Cobra Application
# Provides external access to key application services
# BC Province Services HTTPRoute
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: cobra-bc-services
  namespace: cobra
  labels:
    gc.ca/data-classification: unclassified
    gc.ca/environment: dev
    gc.ca/tier: tier3
    tenant: cobra
    app.kubernetes.io/part-of: iidi
    app.kubernetes.io/component: httproute
    province: bc
  annotations:
    argocd.argoproj.io/sync-wave: "70"
spec:
  parentRefs:
  - name: external-gateway1  # Platform gateway
    namespace: gateway-infra
  hostnames:
  - "bc.iidi.alpha.phac.gc.ca"
  rules:
  # Patient Browser BC
  - matches:
    - path:
        type: PathPrefix
        value: /patient-browser
    backendRefs:
    - name: patient-browser-bc-svc
      port: 8080
  # FHIR Server BC  
  - matches:
    - path:
        type: PathPrefix
        value: /fhir
    backendRefs:
    - name: hapi-fhir-bc-svc
      port: 8080
  # Aggregation Server BC
  - matches:
    - path:
        type: PathPrefix
        value: /aggregator
    backendRefs:
    - name: aggregation-server-bc-svc
      port: 80
  # Transfer Services BC
  - matches:
    - path:
        type: PathPrefix
        value: /transfer-inbound
    backendRefs:
    - name: transfer-inbound-bc-svc
      port: 3000
  - matches:
    - path:
        type: PathPrefix
        value: /transfer-outbound
    backendRefs:
    - name: transfer-outbound-bc-svc
      port: 3000
---
# ON Province Services HTTPRoute
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: cobra-on-services
  namespace: cobra
  labels:
    gc.ca/data-classification: unclassified
    gc.ca/environment: dev
    gc.ca/tier: tier3
    tenant: cobra
    app.kubernetes.io/part-of: iidi
    app.kubernetes.io/component: httproute
    province: on
  annotations:
    argocd.argoproj.io/sync-wave: "70"
spec:
  parentRefs:
  - name: external-gateway1  # Platform gateway
    namespace: gateway-infra
  hostnames:
  - "on.iidi.alpha.phac.gc.ca"
  rules:
  # Patient Browser ON
  - matches:
    - path:
        type: PathPrefix
        value: /patient-browser
    backendRefs:
    - name: patient-browser-on-svc
      port: 8080
  # FHIR Server ON
  - matches:
    - path:
        type: PathPrefix
        value: /fhir
    backendRefs:
    - name: hapi-fhir-on-svc
      port: 8080
  # Aggregation Server ON
  - matches:
    - path:
        type: PathPrefix
        value: /aggregator
    backendRefs:
    - name: aggregation-server-on-svc
      port: 80
  # Transfer Services ON
  - matches:
    - path:
        type: PathPrefix
        value: /transfer-inbound
    backendRefs:
    - name: transfer-inbound-on-svc
      port: 3000
  - matches:
    - path:
        type: PathPrefix
        value: /transfer-outbound
    backendRefs:
    - name: transfer-outbound-on-svc
      port: 3000
---
# Federal Services HTTPRoute
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: cobra-federal-services
  namespace: cobra
  labels:
    gc.ca/data-classification: unclassified
    gc.ca/environment: dev
    gc.ca/tier: tier3
    tenant: cobra
    app.kubernetes.io/part-of: iidi
    app.kubernetes.io/component: httproute
  annotations:
    argocd.argoproj.io/sync-wave: "70"
spec:
  parentRefs:
  - name: external-gateway1  # Platform gateway
    namespace: gateway-infra
  hostnames:
  - "federal.iidi.alpha.phac.gc.ca"
  rules:
  # Federator Service
  - matches:
    - path:
        type: PathPrefix
        value: /federator
    backendRefs:
    - name: federator-svc
      port: 80
  # R Shiny Dashboard
  - matches:
    - path:
        type: PathPrefix
        value: /dashboard
    backendRefs:
    - name: rshiny-dashboard-svc
      port: 3838
---
# Demo Services HTTPRoute
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: cobra-demo-services
  namespace: cobra
  labels:
    gc.ca/data-classification: unclassified
    gc.ca/environment: dev
    gc.ca/tier: tier3
    tenant: cobra
    app.kubernetes.io/part-of: iidi
    app.kubernetes.io/component: httproute
  annotations:
    argocd.argoproj.io/sync-wave: "70"
spec:
  parentRefs:
  - name: external-gateway1  # Platform gateway
    namespace: gateway-infra
  hostnames:
  - "demo.iidi.alpha.phac.gc.ca"
  rules:
  # Demo Portal
  - matches:
    - path:
        type: PathPrefix
        value: /portal
    backendRefs:
    - name: demo-portal
      port: 8080
  # Demo Transfer Dashboard
  - matches:
    - path:
        type: PathPrefix
        value: /transfer-dashboard
    backendRefs:
    - name: demo-transfer-dashboard
      port: 8080
---
# Subdomain-based Routes for Direct Service Access
# ON Services - Individual Subdomains
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: cobra-on-patient-browser-subdomain
  namespace: cobra
  labels:
    gc.ca/data-classification: unclassified
    gc.ca/environment: dev
    gc.ca/tier: tier3
    tenant: cobra
    app.kubernetes.io/part-of: iidi
    app.kubernetes.io/component: httproute
    province: on
  annotations:
    argocd.argoproj.io/sync-wave: "70"
spec:
  parentRefs:
  - name: external-gateway1
    namespace: gateway-infra
  hostnames:
  - "patient-browser.on.iidi.alpha.phac.gc.ca"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: patient-browser-on-svc
      port: 8079
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: cobra-on-fhir-subdomain
  namespace: cobra
  labels:
    gc.ca/data-classification: unclassified
    gc.ca/environment: dev
    gc.ca/tier: tier3
    tenant: cobra
    app.kubernetes.io/part-of: iidi
    app.kubernetes.io/component: httproute
    province: on
  annotations:
    argocd.argoproj.io/sync-wave: "70"
spec:
  parentRefs:
  - name: external-gateway1
    namespace: gateway-infra
  hostnames:
  - "fhir.on.iidi.alpha.phac.gc.ca"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: hapi-fhir-on-svc
      port: 8080
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: cobra-on-aggregator-subdomain
  namespace: cobra
  labels:
    gc.ca/data-classification: unclassified
    gc.ca/environment: dev
    gc.ca/tier: tier3
    tenant: cobra
    app.kubernetes.io/part-of: iidi
    app.kubernetes.io/component: httproute
    province: on
  annotations:
    argocd.argoproj.io/sync-wave: "70"
spec:
  parentRefs:
  - name: external-gateway1
    namespace: gateway-infra
  hostnames:
  - "aggregator.on.iidi.alpha.phac.gc.ca"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: aggregation-server-on-svc
      port: 80
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: cobra-on-transfer-outbound-subdomain
  namespace: cobra
  labels:
    gc.ca/data-classification: unclassified
    gc.ca/environment: dev
    gc.ca/tier: tier3
    tenant: cobra
    app.kubernetes.io/part-of: iidi
    app.kubernetes.io/component: httproute
    province: on
  annotations:
    argocd.argoproj.io/sync-wave: "70"
spec:
  parentRefs:
  - name: external-gateway1
    namespace: gateway-infra
  hostnames:
  - "transfer-outbound.on.iidi.alpha.phac.gc.ca"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: transfer-outbound-on-svc
      port: 3000
---
# Federal Services - Individual Subdomains
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: cobra-federal-federator-subdomain
  namespace: cobra
  labels:
    gc.ca/data-classification: unclassified
    gc.ca/environment: dev
    gc.ca/tier: tier3
    tenant: cobra
    app.kubernetes.io/part-of: iidi
    app.kubernetes.io/component: httproute
  annotations:
    argocd.argoproj.io/sync-wave: "70"
spec:
  parentRefs:
  - name: external-gateway1
    namespace: gateway-infra
  hostnames:
  - "federator.federal.iidi.alpha.phac.gc.ca"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: federator-svc
      port: 80
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: cobra-federal-rshiny-subdomain
  namespace: cobra
  labels:
    gc.ca/data-classification: unclassified
    gc.ca/environment: dev
    gc.ca/tier: tier3
    tenant: cobra
    app.kubernetes.io/part-of: iidi
    app.kubernetes.io/component: httproute
  annotations:
    argocd.argoproj.io/sync-wave: "70"
spec:
  parentRefs:
  - name: external-gateway1
    namespace: gateway-infra
  hostnames:
  - "rshiny-dashboard.federal.iidi.alpha.phac.gc.ca"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: rshiny-dashboard-svc
      port: 80
---
# Demo Services - Individual Subdomains
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: cobra-demo-portal-subdomain
  namespace: cobra
  labels:
    gc.ca/data-classification: unclassified
    gc.ca/environment: dev
    gc.ca/tier: tier3
    tenant: cobra
    app.kubernetes.io/part-of: iidi
    app.kubernetes.io/component: httproute
  annotations:
    argocd.argoproj.io/sync-wave: "70"
spec:
  parentRefs:
  - name: external-gateway1
    namespace: gateway-infra
  hostnames:
  - "demo-portal.iidi.alpha.phac.gc.ca"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: demo-portal
      port: 8080
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: cobra-demo-transfer-dashboard-subdomain
  namespace: cobra
  labels:
    gc.ca/data-classification: unclassified
    gc.ca/environment: dev
    gc.ca/tier: tier3
    tenant: cobra
    app.kubernetes.io/part-of: iidi
    app.kubernetes.io/component: httproute
  annotations:
    argocd.argoproj.io/sync-wave: "70"
spec:
  parentRefs:
  - name: external-gateway1
    namespace: gateway-infra
  hostnames:
  - "demo-transfer-dashboard.iidi.alpha.phac.gc.ca"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: demo-transfer-dashboard
      port: 8080